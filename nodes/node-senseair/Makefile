APPLICATION = node-senseair
BOARD ?= berta-h10

BASE ?= $(CURDIR)/../../
LORA3ABASE ?= $(BASE)/../lora3a-boards
RIOTBASE ?= $(BASE)/../RIOT

EXTERNAL_BOARD_DIRS=$(LORA3ABASE)/boards
EXTERNAL_MODULE_DIRS+=$(LORA3ABASE)/modules
EXTERNAL_MODULE_DIRS+=$(BASE)/shared_modules
EXTERNAL_PKG_DIRS=$(LORA3ABASE)/pkg

QUIET ?= 1
PORT ?= /dev/ttyUSB0

ACME_DEBUG ?= 1
ifneq ($(ACME_DEBUG),)
	CFLAGS += -DACME_DEBUG=$(ACME_DEBUG)
endif

USEMODULE += fmt
USEMODULE += periph_adc
USEMODULE += periph_spi_reconfigure
USEMODULE += periph_cpuid
USEMODULE += printf_float
USEMODULE += saml21_backup_mode
USEMODULE += acme_lora
USEMODULE += nodes_data
USEMODULE += h10_adc

CFLAGS += -DSLEEP_TIME=30

# SENSEAIR + FRAM
USEMODULE += senseair
USEMODULE += fram

ACME_PORT ?= 1

ifeq ($(ACME_PORT), 0)
CFLAGS += -DACME0_BUS_MODE=MODE_I2C
CFLAGS += -DSENSEAIR_I2C_DEV=ACME0_I2C_DEV -DSENSEAIR_ENABLE_PIN=GPIO_PIN\(PA,19\) -DACME_BUS_POWER_PIN=ACME0_POWER_PIN -DFRAM_ENABLE_PIN=ACME0_POWER_PIN
endif

ifeq ($(ACME_PORT), 1)
CFLAGS += -DACME0_BUS_MODE=MODE_I2C
CFLAGS += -DACME1_BUS_MODE=MODE_I2C

CFLAGS += -DSENSEAIR_I2C_DEV=ACME1_I2C_DEV -DSENSEAIR_ENABLE_PIN=GPIO_PIN\(PB,23\) -DACME_BUS_POWER_PIN=ACME1_POWER_PIN -DFRAM_ENABLE_PIN=ACME0_POWER_PIN
endif

ifeq ($(ACME_PORT), 2)
CFLAGS += -DACME0_BUS_MODE=MODE_I2C
CFLAGS += -DACME2_BUS_MODE=MODE_I2C

CFLAGS += -DSENSEAIR_I2C_DEV=ACME2_I2C_DEV -DSENSEAIR_ENABLE_PIN=GPIO_PIN\(PA,7\) -DACME_BUS_POWER_PIN=ACME2_POWER_PIN -DFRAM_ENABLE_PIN=ACME0_POWER_PIN
endif

BW ?= 2
CH ?= 869500000L
SF ?= 7
CR ?= 1

ifneq ($(BW),)
	CFLAGS+=-DDEFAULT_LORA_BANDWIDTH=$(BW)
endif

ifneq ($(SF),)
	CFLAGS+=-DDEFAULT_LORA_SPREADING_FACTOR=$(SF)
endif

ifneq ($(CR),)
	CFLAGS+=-DDEFAULT_LORA_CODERATE=$(CR)
endif

ifneq ($(CH),)
	CFLAGS+=-DDEFAULT_LORA_CHANNEL=$(CH)
endif

ifneq ($(PW),)
	CFLAGS+=-DDEFAULT_LORA_POWER=$(PW)
endif

ifneq ($(BS),)
	CFLAGS+=-DDEFAULT_LORA_BOOST=$(BS)
endif

include $(RIOTBASE)/Makefile.include
include $(LORA3ABASE)/Makefile.include
